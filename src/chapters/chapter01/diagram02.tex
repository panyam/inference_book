% Diagram: Autoregressive Inference
% Used in: Chapter 1, Section 1.1.2 (What Happens During Inference)
\begin{figure}[htbp]
\centering
\begin{tikzpicture}[
    node distance=0.8cm,
    box/.style={rectangle, draw, minimum width=1.8cm, minimum height=0.6cm, align=center, font=\small},
    model/.style={rectangle, draw, fill=gray!20, minimum width=1.5cm, minimum height=0.6cm, align=center, font=\small},
    cache/.style={rectangle, draw, fill=blue!10, minimum height=0.6cm, align=center, font=\scriptsize},
    arrow/.style={->, >=stealth}
]
    % Step 1
    \node[box] (p1) {Prompt};
    \node[model, right=of p1] (m1) {Model};
    \node[box, right=of m1] (t1) {Token 1};
    \draw[arrow] (p1) -- (m1);
    \draw[arrow] (m1) -- (t1);

    % Step 2
    \node[box, below=1.2cm of p1] (p2) {Prompt + T1};
    \node[model, right=of p2] (m2) {Model};
    \node[cache, below=0.1cm of m2, minimum width=0.8cm] (kv2) {KV};
    \node[box, right=of m2] (t2) {Token 2};
    \draw[arrow] (p2) -- (m2);
    \draw[arrow] (m2) -- (t2);
    \draw[arrow, dashed, gray] (t1) -- (p2);

    % Step 3
    \node[box, below=1.2cm of p2] (p3) {Prompt + T1 + T2};
    \node[model, right=of p3] (m3) {Model};
    \node[cache, below=0.1cm of m3, minimum width=1.2cm] (kv3) {KV Cache};
    \node[box, right=of m3] (t3) {Token 3};
    \draw[arrow] (p3) -- (m3);
    \draw[arrow] (m3) -- (t3);
    \draw[arrow, dashed, gray] (t2) -- (p3);

    % Labels
    \node[left=0.3cm of p1, font=\scriptsize] {Step 1:};
    \node[left=0.3cm of p2, font=\scriptsize] {Step 2:};
    \node[left=0.3cm of p3, font=\scriptsize] {Step 3:};

    % Note
    \node[below=0.5cm of kv3, font=\scriptsize, text=blue!60!black] {KV cache grows with context length};
\end{tikzpicture}
\caption{Autoregressive inference. Each token is generated by a forward pass through the model, then appended to the context for the next iteration. The KV cache stores intermediate attention computations to avoid redundant work, growing with each generated token.}
\label{fig:autoregressive-inference}
\end{figure}
